# .github/workflows/python-ci.yml

name: Python Test and Performance CI

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

  # # ğŸ‘‡ ìŠ¤ì¼€ì¤„ë§ íŠ¸ë¦¬ê±°
  # schedule:
  #   # cron í‘œí˜„ì‹: "ë§¤ì‹œê°„ 0ë¶„ì— ì‹¤í–‰" (UTC ê¸°ì¤€)
  #   # í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œëŠ” ë§¤ì‹œê°„ 59ë¶„ì´ ì•„ë‹Œ ì •ê°(09:00, 10:00...)ì— ì‹¤í–‰ë©ë‹ˆë‹¤.
  #   - cron: '10 * * * *'

jobs:
  # 1. ê¸°ì¡´ ë‹¨ìœ„/í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì—… (ìˆ˜ì • ì—†ìŒ)
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: 1234
          MYSQL_DATABASE: mydatabase_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run Pytest
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}
        run: |
          pytest -v -m "not simulation"
  # --- ğŸ‘‡ [ì‹ ê·œ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‘ì—… ì¶”ê°€ ---
  performance-test:
    # 'test' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ ì‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    needs: test
    runs-on: ubuntu-latest

    services:
      # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ìš© DBë„ ë™ì¼í•˜ê²Œ ì„¤ì •
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: 1234
          MYSQL_DATABASE: mydatabase_test # ì‹¤ì œ DB ì´ë¦„ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      # --- ğŸ‘‡ [ì‹ ê·œ] DB í…Œì´ë¸” ìƒì„± ë‹¨ê³„ ì¶”ê°€ ---
      - name: Create database tables
        run: python init_db.py

      # 6. Gunicornìœ¼ë¡œ FastAPI ì„œë²„ ì‹¤í–‰ ë° Locust ë¶€í•˜ í…ŒìŠ¤íŠ¸
      - name: Run FastAPI Server & Locust Performance Test
        run: |
          # Gunicornì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ (&)
          gunicorn -w 2 -k uvicorn.workers.UvicornWorker app.main:app &
          sleep 5
          # reports ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p reports
          # Locustë¥¼ í—¤ë“œë¦¬ìŠ¤ ëª¨ë“œë¡œ ì‹¤í–‰í•˜ì—¬ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹œì‘
          locust -f performance_tests/locustfile.py \
            --headless \
            --users 20 --spawn-rate 5 \
            --run-time 30s \
            --html reports/performance_report.html \
            --csv reports/performance_report
      # 7. ìƒì„±ëœ ë¦¬í¬íŠ¸ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: locust-report
          path: reports/
