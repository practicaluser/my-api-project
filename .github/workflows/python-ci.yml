# .github/workflows/python-ci.yml

name: Python Test CI # ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„

# 1. ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ê²ƒì¸ê°€?
on:
  push:
    branches: ['main'] # main ë¸Œëœì¹˜ì— push ë  ë•Œë§ˆë‹¤ ì‹¤í–‰
  pull_request:
    branches: ['main'] # main ë¸Œëœì¹˜ë¡œ pull requestê°€ ìƒì„±ë  ë•Œë§ˆë‹¤ ì‹¤í–‰

  # # ğŸ‘‡ ìŠ¤ì¼€ì¤„ë§ íŠ¸ë¦¬ê±°
  # schedule:
  #   # cron í‘œí˜„ì‹: "ë§¤ì‹œê°„ 0ë¶„ì— ì‹¤í–‰" (UTC ê¸°ì¤€)
  #   # í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œëŠ” ë§¤ì‹œê°„ 59ë¶„ì´ ì•„ë‹Œ ì •ê°(09:00, 10:00...)ì— ì‹¤í–‰ë©ë‹ˆë‹¤.
  #   - cron: '10 * * * *'

# 2. ì–´ë–¤ ì‘ì—…ë“¤ì„ ìˆ˜í–‰í•  ê²ƒì¸ê°€?
jobs:
  test: # 'test' ë¼ëŠ” ì´ë¦„ì˜ ì‘ì—…ì„ ì •ì˜
    runs-on: ubuntu-latest # 3. ì–´ë–¤ í™˜ê²½ì—ì„œ ì‹¤í–‰í•  ê²ƒì¸ê°€? -> ìµœì‹  ìš°ë¶„íˆ¬ ë¦¬ëˆ…ìŠ¤

    # 4. 'ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ'ë¥¼ ì‚¬ìš©í•˜ì—¬ MySQL DBë¥¼ ì‹¤í–‰
    services:
      mysql:
        image: mysql:8.0 # Docker Hubì˜ ê³µì‹ MySQL 8.0 ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©
        env: # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          MYSQL_ROOT_PASSWORD: 1234 # conftest.pyì˜ ë¹„ë°€ë²ˆí˜¸ì™€ ì¼ì¹˜
          MYSQL_DATABASE: mydatabase_test # conftest.pyì˜ DB ì´ë¦„ê³¼ ì¼ì¹˜
        ports:
          - 3306:3306 # ê°€ìƒë¨¸ì‹ ì˜ 3306 í¬íŠ¸ì™€ MySQL ì»¨í…Œì´ë„ˆì˜ 3306 í¬íŠ¸ë¥¼ ì—°ê²°
        # MySQLì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸° ìœ„í•œ í—¬ìŠ¤ ì²´í¬ ì˜µì…˜
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    # 5. ì‹¤ì œ ì‘ì—… ë‹¨ê³„ë“¤
    steps:
      # 5-1. ë¦¬í¬ì§€í† ë¦¬ì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ìƒë¨¸ì‹ ìœ¼ë¡œ ë‚´ë ¤ë°›ê¸°
      - name: Checkout repository
        uses: actions/checkout@v4

      # 5-2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # ì‚¬ìš©í•  íŒŒì´ì¬ ë²„ì „ ëª…ì‹œ

      # 5-3. íŒŒì´ì¬ ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5-4. Pytest ì‹¤í–‰ (API + ë¶„ì„ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸)
      - name: Run Pytest
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}
        run: |
          pytest -v -m "not simulation"
